下面给出一份“可落地、按依赖顺序推进、且符合你们‘超参应内生’原则”的综合解决方案。目标很明确：**打破分支等势脊上的对称性（top-2 gap 中位数=0），让桥接带断裂，同时保持 tree_dist_corr 的高对齐。**

---

## 总体策略

1. **先解锁动力学的“跨势垒能力”**：把自适应步长从 *force-limited* 改为 *displacement-limited*，并用“隐式求解可解性”作为安全护栏，而不是用 torque 直接把 dt 压到冻结。
2. **再引入“测度屏障/对称破缺项”**：针对“兄弟分支的责任混合”施加硬化，系数由系统状态内生给出（z、桥接率、top-2 gap）。
3. **必要时第三步**：把“温度/分辨率”也内生化（β(z)），作为 A 的平滑版本或补充。

---

## 方案 C：位移限制步长 + 求解器回退（必须先做）

### C1. 主步长律：控制几何位移，不再直接用 torque 压 dt

用你们已有的 (\xi)（李代数速度）作为主约束，令每步最大“几何步进”受控：

[
dt_\text{disp}=\frac{\varepsilon_s}{\max(|\xi|, v_\text{floor})}
]

* (\varepsilon_s)：**最大允许几何步长**（这是“几何分辨率”，不是物理超参；可由曲率尺度/惯性谱内生给出，见后面）
* (v_\text{floor})：速度地板，避免 (|\xi|\to0) 时 dt 爆大（导致乱跳）

> 关键点：**torque 不再直接进入 dt 分母**，否则熵势一上就死锁。

### C2. 次级护栏：用“隐式求解可解性”回退 dt（而不是力大小）

在每个 step 内做“尝试—求解—验收”：

* 用 dt_disp 做一次隐式求解（fixed-point/Newton）
* 验收条件（任意一个触发回退即可）：

  * 动量平衡残差 (|F|) > tol_F
  * 接触残差 (|r_k|) > tol_r
  * 迭代次数超过阈值或收敛失败
  * 更新后点越界/数值异常
* 若失败：`dt *= 0.5` 重试（最多 N 次）

这样 dt 会在真正“不可解”的时候缩小，而不是在“力大但可解”时自动冻结。

### C3. 让 (\varepsilon_s) 内生化（符合你们原则）

可以用惯性谱/阻尼尺度给出一个自然尺度：

* 例如 (\varepsilon_s = c / \sqrt{\lambda_{\max}(I^{-1})}) 或其单调函数（你们已经在用 inertia 谱构造 γ 的思路）
* 或与接触变量 z 相关：系统越“困惑/桥接越久”，允许更大步进以促成相变（谨慎使用，上限由求解器回退控制）

**验收指标（做完 C 就要测）：**

* dt 不再长期锁死在 1e-4；会出现更合理的动态范围；
* top-2 gap 中位数是否从 0 略有抬升（哪怕不多，也说明不再被边界带锁死）；
* kNN 桥接比例是否不再“全程常数”。

---

## 方案 A：兄弟分支责任硬化（测度屏障/对称破缺项）

### A1. 作用对象：对“同一父节点下的 siblings 责任”做硬化

不要对所有 anchors 全局加熵惩罚，否则会制造不必要的尖峰和耦合。对每个点 x，在每个分叉处只对该分叉的兄弟集合 (S) 的责任分布 (p_S(x)) 加项：

* 选用熵项或 KL 项均可：

  * 熵硬化：(;V_\text{ent}(x)=\lambda\cdot H(p_S(x)))
  * 或：(;V_\text{KL}(x)=\lambda\cdot \mathrm{KL}(p_S(x),|,\pi_S))（(\pi_S) 是树先验，如均匀或按子树规模）

其物理含义就是你报告里说的：在等势脊上引入“对称破缺倾向”，迫使系统选边。

### A2. 系数 (\lambda) 必须内生：用 z / 桥接 / gap 驱动

建议用一个单调调度律，避免手调常数：

* 触发条件用你们已有的诊断量：

  * `gap_median` 趋近 0
  * `bridge_ratio` 高且长时间不降
  * z（action/surprise）累积偏大
* 例如：
  [
  \lambda = \lambda_{\max}\cdot \sigma\Big(a,(b_0-\text{gap_median}) + c,(\text{bridge}-\beta_0) + d,(z-z_0)\Big)
  ]
  其中 (\sigma) 是 sigmoid；阈值 (b_0,\beta_0,z_0) 可以由统计量自适应设定（例如滑动分位数），避免硬编码。

> 要点：(\lambda) 在“桥接/不决”时升高，在“已决策”时自动降低，避免过硬导致早熟锁定。

### A3. 数值实现注意：避免造成不可导尖峰

* 责任分布建议来自 soft assignments（你已经有 layer_soft_stats 的计算路径），并用平滑的 log-sum-exp 形式避免硬 argmax；
* 熵项本身是平滑的，但当责任非常接近 0/1 时要加 epsilon 防止 log(0)。

**验收指标（做完 A 就要测）：**

* top-2 gap 中位数显著 > 0（这是最关键的“对称破缺成功”指标）
* kNN 桥接比例下降（尤其 k=1..3）
* k-means/k-medoids 的簇大小从极不均衡（36/13/1）变得更均衡，silhouette 不一定大幅上升但应不再接近 0
* tree_dist_corr 维持在高位（不应被破坏）

---

## 方案 B：内生温度 β(z)（可选增强/平滑器）

如果你担心 A 太硬或容易引入尖峰，可以先上 B 或把 B 作为 A 的“软版本”：

* 令 softmin 逆温度 β 随状态变化：

  * 桥接强 / gap 中位数为 0 → 提高 β（更硬，促进分裂）
  * 过早锁定 / 局部最优 → 降低 β（更软，允许探索）
* β 同样由 z 或桥接指标内生调度。

B 的优点是比直接加势垒更平滑；缺点是对称破缺力度可能不足，需要和 A 结合。

---

## 观测与回归测试（确保不是“刷分”）

每次改动后固定输出以下四类曲线/统计（你们已有大部分）：

1. `gap_median(t)`、gap 分布分位数
2. `bridge_ratio_k(t)`（k=1..5 或至少 k=3）
3. `dt(t)` 与求解器回退次数统计（每步重试次数）
4. `tree_dist_corr(t)`、以及最终的 `cluster_counts`（k-medoids + k-means 两套，避免单一观测器偏差）

你们的成功标准应当是：**gap 抬升 + 桥接下降 + 对齐保持**，而不是单看 silhouette。

---

## 推荐执行顺序（最小闭环）

1. **仅实施 C（位移限制 dt + 求解器回退）**：观察桥接是否已经松动、gap 是否抬升。
2. 若桥接仍稳态：实施 **A（兄弟分支熵/KL 硬化，(\lambda) 内生调度）**。
3. 若 A 过硬/不稳定：用 **B（β(z)）**平滑，并保留求解器回退作为安全网。

---


