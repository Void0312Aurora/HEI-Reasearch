

---

## 1) Test2：惯性谱极端，是公式结构导致的，不是“没夹够”

你的锁定惯性实现来自动能
[
2T=\sum_k m_k\frac{|v+2uz_k-w z_k^2|^2}{y_k^2}
]
在代码里被直接展开成 `a_u=2z, a_v=1, a_w=-z^2`，再用 `scale = m/y^2` 累加得到 3×3 的 (I)（含交叉项）。而 Möbius 速度场也正是同一个表达式 `v + 2u z - w z^2`。

关键在于：当你在 Disk 上取 (z\to 1)（比如 0.99），Cayley 到 UHP 后 (y) 会变得很大（你的 Test2 也明确在测这个）。此时若 (z\approx i y)，则三项在“除以 (y^2)”后尺度大致是：

* **v 方向**：(|1|^2/y^2 \sim 1/y^2)（极小）
* **u 方向**：(|2z|^2/y^2 \sim 4y^2/y^2 \sim O(1))（中等）
* **w 方向**：(|z^2|^2/y^2 \sim y^4/y^2 \sim y^2)（极大）

所以你看到的特征值形如 ([10^6,10^{-4},10^4]) 或 ([10^8,10^{-4},4\times 10^4]) 是**结构必然**：这是“基向量在该位置的物理量纲极不均衡”，不是单纯的数值噪声。

而你现在的“谱夹断”是 **绝对阈值**：把特征值裁到 ([10^{-9},10^{12}])。这会避免奇异，但**不会控制条件数**，因此条件数仍然可以稳定落在 (10^{10}\sim 10^{12}) 量级——这和你观测完全一致。

> 结论：要让 Test2 真正“变好”，需要的不是更猛的 clip，而是**换坐标/换基/预条件**（或改变模型，使 (I) 不再来自这个诱导动能）。

---

## 2) Test3：真空漂移 28% 的核心原因，是“你在真空里仍在做非变分的干预 + 强行可逆化”

你的 Test3 明确要求：无势、无耗散，能量 (E=\tfrac12\xi^T I \xi) 应该守恒，并据此测漂移。但当前实现里，即使 `gamma_fn=0`、`force_fn=0`，仍然存在三类会破坏守恒的机制：

### (a) **锁定惯性本身对单点/退化构型是“天然奇异”的，你把它强行 SPD 化了**

对单个点，存在 1 维稳定子（某个方向的群生成元对该点“速度为 0”），所以“正确的”锁定惯性应当出现零特征值（这是几何事实，不是 bug）。但你把特征值硬抬到了 `EIG_FLOOR=1e-9`，然后 `invert_inertia` 用 `np.linalg.solve` 当成严格可逆。

这一步会把“本该是规范方向/零动能方向”的分量引入动力学，等价于**在真空里注入虚假的惯性结构**，能量漂移是预期后果。

### (b) **积分器在每步里有多处“重写状态”的安全策略，会改变动量/能量**

在 `step()` 里，你会对 `xi_new` 进行三连裁剪：`max_xi_norm`、`xi_clip`、`step_clip`，每次裁剪都同步重算 `m_new = I xi_new`。这相当于对系统施加了离散冲量（而且不来自势/耗散），当然会导致 Test3 漂移。

另外，每个子步都会把点集做一次“投影到安全域”：Disk clamp → Cayley → UHP clamp；而 Cayley 映射里对半径用了更强的 `eps=1e-4` 固定夹断。这也是一种非等距、非变分的扰动源。

### (c) **你在真空里仍然“每步重算 I(z)”并在隐式循环里覆盖 state.I**

Test3 循环里每步显式 `state.I = locked_inertia_uhp(state.z_uhp)`，而 integrator 内部又在 fixed-point 迭代里再次 `I_new = locked_inertia_uhp(z_guess)` 并覆盖 `state.I`。这会把“几何依赖的度量变化 + 数值投影/裁剪”揉在一起，Test3 实际测到的更多是**控制逻辑引入的非保守扰动**，而不是理想 DCVI 的性质——这点你自己在描述里已经非常接近根因了。

> 结论：在当前代码结构下，Test3 的 28% 漂移并不意外；要让它过关，必须先提供一个“纯净模式”（禁用裁剪/投影/强行 SPD）并用**伪逆/约束**处理锁定惯性的奇异性。

---

## 3) “早期脉冲后冻结”的一个明确实现级问题：dt 用了过期的 gamma

你当前步长选择 `_backtrack_dt()` 用的是 `state.gamma_last`，若其为 0 就当作 1.0；但同一个 `step()` 开头马上就用 **当前** `gamma_prev = gamma_fn(state.z_uhp)` 来算耗散系数 `alpha_prev`。

这会导致首步/某些步出现典型灾难：

* dt 评估阶段认为 “gamma≈1（甚至更小）”，于是允许 **很大的 dt**
* 但真正更新动量时，`alpha=(1-0.5 dt gamma)/(1+0.5 dt gamma)` 若 gamma 实际很大（你仿真默认的 `gamma_critical_inertia` 与 (\sqrt{\lambda_{\max}(I)}) 成正比），则 **dt·gamma 可能远超 1**，`alpha` 会极小甚至变号
* 结果就是：动量/速度先被扭矩推一脚（脉冲），随后在一个过大的 dt 下被耗散项瞬间“打死”，表现为长时间冻结、速度均方迅速归零、Z 线性坍塌

> 这不是理论难题，是一个非常具体的“步长稳定性约束用错量”的实现问题。

---

## 4) 另一个结构性不一致：Diamond 扭矩对 z 做了截断，但惯性没有同口径截断

Diamond 扭矩在单点上对 `|z|>100` 会把 z 缩放回 100，但 `locked_inertia_uhp()` 用的 z 没有同样的 lever-arm 截断。

这会造成非常糟糕的“力矩-惯性标定不一致”：

* 在边界附近（Cayley 后 z 的量级很大），**惯性可以继续按 (z^2) / (z^4) 级别增长/失衡**
* 但扭矩被人为限幅，导致实际加速度/动量更新出现非物理的“先猛一下、后完全推不动”或“推一下就被 dt/gamma 吃掉”的组合效应

---

## 5) 针对你当前三类症状的修复优先级建议

### P0（必须先做，否则“越调参越像玄学”）

1. **把 `invert_inertia` 改成基于特征分解的伪逆/约束解**，不要靠 `EIG_FLOOR` 把奇异性抹掉

   * 维持 (I) 允许半正定（对应稳定子/退化构型），在求解 (\xi) 时对小特征值置零或 Tikhonov 正则。
   * 否则 Test3 的“真空守恒”从数学上就站不住。

2. **修正 `_backtrack_dt` 的 gamma 使用：用当前 `gamma_fn(state.z_uhp)`（至少取 max(current, gamma_last)）**

   * 你已经有 `gamma_prev`，但 dt 约束没用它 vs 。
   * 并额外硬约束 `dt*gamma < 2`，避免 `alpha` 变号（否则“脉冲→冻结”会非常稳定地复现）。

3. **提供“纯净积分器模式”用于 Test3/理论一致性验证**

   * 禁用 `xi_clip/step_clip/max_xi_norm` 的重写动量逻辑
   * 禁用 `_stabilize_uhp` 投影
     否则 Test3 永远是在测“安全补丁的副作用”。

### P1（解决 Test2 病态谱的正道）

4. **对 ((u,v,w)) 采用“基变换/预条件”而不是硬 clip 特征值**
   你现在的病态是坐标尺度导致的。做一个基变换（哪怕先用一个与 `median(Im(z))` 相关的对角缩放）通常会比任何 eigen clip 更有效，因为它从根上把 (v\sim 1/y)、(w\sim y) 的尺度拉回同量级。

5. **让 Diamond 截断与惯性截断同口径（或者统一改到 Disk 上计算）**
   目前 `MAX_LEVER_ARM` 只在扭矩侧生效，这是结构性不一致，应该消除。

---


